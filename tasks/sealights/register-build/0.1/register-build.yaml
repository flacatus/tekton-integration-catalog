apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sealights-go-instrumentation
spec:
  results:
    - name: build-session-id
      type: string
      description: "A unique identifier generated for the current sealights build session."
    - name: build-name
      type: string
      description: "A unique build name generated using the commit SHA and current date to prevent conflicts during test reruns."
  params:
    - name: source-artifact
      description: The Trusted Artifact URI pointing to the artifact with
        the application source code.
      type: string
    - name: go-version
      type: string
      description: "The Go version to use with the 'ubi8/go-toolset' image, in the format '1.x.y' (e.g., '1.21.3')."
    - name: sealights-secret
      type: string
      description: "The name of the Openshift secret containing Sealights credentials."
    - name: component
      type: string
      description: "The name of the Konflux component associated with the integration tests."
    - name: scm-provider
      type: string
      default: "github"
      description: "The source control management (SCM) provider used for the project, such as 'github', 'gitlab'."
    - name: repository-url
      type: string
      description: "The name or URL of the source code repository (e.g., 'github.com/org/repo')."
      default: ""
    - name: branch
      type: string
      description: "The name of the Git branch to use for the operation (e.g., 'main' or 'feature-branch')."
      default: "main"
    - name: revision
      type: string
      description: "The Git revision (commit SHA) from which the test pipeline is originating."
    - name: pull-request-number
      type: string
      description: "The identifier number of the pull request/merge request."
      default: ""
    - name: target-branch
      type: string
      description: "The name of the target branch for the pull request, typically the branch into which the changes will be merged (e.g., 'main', 'develop')."
      default: "main"
  volumes:
    - name: sealights-credentials
      secret:
        secretName: sealights-credentials
    - name: workdir
      emptyDir: {}
  stepTemplate:
    volumeMounts:
      - mountPath: /var/workdir
        name: workdir
      - name: konflux-sealights
        mountPath: /usr/local/konflux-sealights
  steps:
    - name: use-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:52f1391e6f1c472fd10bb838f64fae2ed3320c636f536014978a5ddbdfc6b3af
      args:
        - use
        - $(params.source-artifact)=/var/workdir/source
    - name: sealights-code-scan
      image: registry.access.redhat.com/ubi9/ubi:latest
      env:
        - name: COMMIT_SHA
          value: $(params.git-revision)
        - name: SOURCE_REPO
          value: $(params.source-repo)
        - name: SOURCE_BRANCH
          value: $(params.source-branch)
      script: |
        #!/bin/sh

        ls -larth /var/workdir/source
