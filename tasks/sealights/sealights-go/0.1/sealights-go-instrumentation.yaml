apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: register-build
spec:
  results:
    - name: sealights-session-id
      description: Sealights Session Id.
    - name: build-id
      description: The build id generated for sealights
  params:
    - name: git-revision
      type: string
      description: The Git revision (commit SHA) from which the test pipeline is originating.
      default: "main"
    - name: source-repo
      type: string
      description: The Git URL from which the test pipeline is originating. This can be from a fork or the original repository.
      default: ""
    - name: source-branch
      type: string
      description: The branch from the fork or upstream repo where the pipeline is executed.
      default: "main"
  volumes:
    - name: konflux-sealights
      secret:
        secretName: sealights-secret
  steps:
    - name: sealights-code-scan
      image: registry.access.redhat.com/ubi9/ubi:latest
      env:
        - name: COMMIT_SHA
          value: $(params.git-revision)
        - name: SOURCE_REPO
          value: $(params.source-repo)
        - name: SOURCE_BRANCH
          value: $(params.source-branch)
      volumeMounts:
        - name: konflux-sealights
          mountPath: /usr/local/konflux-sealights
      script: |
        #!/bin/sh
        export BUILD_ID="${COMMIT_SHA}_$(date +'%y%m%d.%H%M')"

        dnf -y --setopt=tsflags=nodocs install \
          golang \
          make \
          git \
          && dnf clean all
        go install github.com/onsi/ginkgo/v2/ginkgo@latest
        
        SLGO_AGENT_URL="https://agents.sealights.co/slgoagent/latest/slgoagent-linux-amd64.tar.gz"
        SLCLI_URL="https://agents.sealights.co/slcli/latest/slcli-linux-amd64.tar.gz"

        echo "[INFO] Downloading and extracting Sealights GO Agent..."
        curl -sSL "$SLGO_AGENT_URL" | tar -xz -C /usr/local/bin/

        echo "[INFO] Downloading and extracting Sealights CLI..."
        curl -sSL "$SLCLI_URL" | tar -xz -C /usr/local/bin/

        cd $(mktemp -d)
        export BUILD_ID="${COMMIT_SHA}_$(date +'%y%m%d.%H%M')"

        git clone -b ${SOURCE_BRANCH} ${SOURCE_REPO} .
        go mod tidy && go mod vendor

        slcli config init --lang go --token /usr/local/konflux-sealights/token
        slcli config create-bsid --app k8s-namespace-creator --branch ${SOURCE_BRANCH} --build ${BUILD_ID}
        slcli scan --bsid buildSessionId.txt --path-to-scanner /usr/local/bin/slgoagent --workspacepath . --scm git

        cat buildSessionId.txt > $(results.sealights-session-id.path)
        echo -n "$BUILD_ID" > $(results.build-id.path)
                      
        ginkgo --junit-report "$ARTIFACT_DIR"/junit_sample.xml
